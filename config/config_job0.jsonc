{
  "paths": {
    // Directory containing processed shards
    "processed_data_dir": "data/processed_quarter",
    // List of raw HDF5 files (optional; auto-detect if empty)
    "raw_data_files": [],
    // Directory for logs/checkpoints/exports
    "work_dir": "models/3",
    // Delete existing work_dir before start
    "overwrite": false
  },

  "system": {
    // Enable cuDNN autotuning (faster, non-deterministic convs)
    "cudnn_benchmark": true,
    // Force deterministic operations (slower)
    "deterministic": false,
    // Model parameter dtype (fallback only; preprocessing uses io_dtype if set)
    "dtype": "float32",
    // On-disk NPZ dtype for preprocessing output
    "io_dtype": "float32",
    // Allow TF32 tensor cores on Ampere/Hopper
    "tf32": true,
    // Max OpenMP threads for CPU ops
    "omp_num_threads": 4,
    // Global RNG seed
    "seed": 42
  },

  "mixed_precision": {
    // AMP precision: "bf16", "fp16", or "none"
    "mode": "bf16"
  },

  "data": {
    // Global inputs (e.g., P, T)
    "global_variables": ["P", "T"],
    // Name of the time column in raw files
    "time_variable": "t_time",
    // Species list; hydrated from artifacts if empty
    "species_variables": [],
    // Subset of species to predict; empty = all
    "target_species": []
  },

  "normalization": {
    // Default normalization for unspecified keys
    "default_method": "log-standard",
    // Small positive floor for log transforms
    "epsilon": 1e-30,
    // Per-key normalization methods
    "methods": {
      "P": "log-min-max",
      "T": "standard",
      "dt": "log-min-max",
      "t_time": "log-min-max"
    },
    // Minimum stddev to avoid division blow-up
    "min_std": 1e-10
  },

  "preprocessing": {
    // Read chunk length for HDF5 (0 = full)
    "hdf5_chunk_size": 0,
    // Drop profiles with any value below this (<=0 keeps all)
    "min_value_threshold": 1e-30,
    // Compress NPZ shards (smaller, slower I/O)
    "npz_compressed": false,
    // Workers for preprocessing (I/O bound; ignored under MPI)
    "num_workers": 32,
    // Trajectories per output shard
    "trajectories_per_shard": 65536,
    // Drop t=0 row when exporting shards
    "skip_first_timestep": false,
    // Reuse the data if possible
    "overwrite_data": false
  },

  "dataset": {
    // Global training batch size
    "batch_size_train": 1024,

    // Optional: override dataset tensor dtype (null = use AMP dtype on CUDA; float32 forced on CPU/MPS)
    // Allowed strings: "float32", "float16", "bf16"/"bfloat16"
    "storage_dtype": null,

    // np.load mmap mode for reading shard .npz files ("r" = memmap; null/false disables memmap)
    "mmap_mode": "r",

    // Avoid full shard scan for the preprocessed data; trust metadata files
    "skip_scan": true,
    // Skip time-grid monotonicity checks
    "skip_validate_grids": true,
    // Precompute normalized Δt table for shared grids
    "precompute_dt_table": true,
    // Return K targets per anchor (K=times_per_anchor)
    "multi_time_per_anchor": true,
    // K: number of target steps per anchor when multi_time_per_anchor
    "times_per_anchor": 4,
    // Use same offsets for entire batch
    "share_times_across_batch": false,
    // Sample offsets uniformly then fit anchors
    "uniform_offset_sampling_strict": false,
    // Assume all trajectories share the same time grid
    "assume_shared_grid": true,
    // Δt clamp floor before normalization
    "dt_epsilon": 1e-30,

    // Use the very first anchor point
    "use_first_anchor": true,

    // DataLoader workers
    "num_workers": 16,
    // Keep workers alive between epochs
    "persistent_workers": true,
    // Pin memory for faster H2D copies (use only when CPU-staged)
    "pin_memory": true,
    // Prefetch batches per worker
    "prefetch_factor": 4,
    // Stage entire set to GPU at init
    "preload_to_gpu": false
  },

  "model": {
    // Latent channel count for autoencoder
    "latent_dim": 256,
    // Encoder MLP hidden sizes
    "encoder_hidden": [1024, 1024, 1024, 1024],
    // Dynamics MLP hidden sizes
    "dynamics_hidden": [1024, 1024, 1024, 1024],
    // Decoder MLP hidden sizes
    "decoder_hidden": [1024, 1024, 1024, 1024],
    // Nonlinearity for MLPs
    "activation": "silu",
    // Dropout rate in MLPs
    "dropout": 0.0,
    // Use VAE-style stochastic encoder (if supported by your model.py)
    "vae_mode": false,
    // Predict Δz and add to z (residual dynamics)
    "dynamics_residual": true,
    // Decoder predicts Δy in z-space
    "predict_delta": true,
    // Decoder predicts Δlog10(y) in physical space
    "predict_delta_log_phys": false,
    // Use log-softmax head for simplex outputs
    "softmax_head": false,
    // Allow softmax on subset of species
    "allow_partial_simplex": false
  },

  "training": {
    // Total epochs to train
    "epochs": 100,
    // Clip grad-norm at this value (0 = disabled)
    "gradient_clip": 0.0,
    // Gradient accumulation steps
    "accumulate_grad_batches": 1,

    // Optimizer choice: "adamw" (default) or "lamb"
    "optimizer": "adamw",

    "torch_compile": false,
    "torch_compile_backend": "inductor",
    "torch_compile_mode": "max-autotune",
    "compile_dynamic": false,
    "compile_fullgraph": true,

    // Initial learning rate
    "lr": 1e-4,
    // Cosine schedule minimum learning rate
    "min_lr": 1e-6,
    // Linear warmup epochs before cosine
    "warmup_epochs": 10,
    // Weight decay for AdamW
    "weight_decay": 1e-4,

    // SWA: no separate lr/min_lr; it derives from the main schedule
    "use_swa": false,
    "swa_epoch_start": 0.8, // fraction of total epochs OR absolute int epoch
    "swa_annealing_epochs": 10,
    "swa_annealing_strategy": "cos",

    // Limit training steps per epoch (0 = no limit)
    "max_train_steps_per_epoch": 0,
    // Limit validation batches per epoch (0 = no limit)
    "max_val_batches": 0,
    // Checkpoint path to resume from (optional)
    "resume": null,
    // Allow auto-resume from config/env/CLI
    "auto_resume": false,

    // Subsample fraction of trajectories during preprocessing
    "use_fraction": 1.0,
    // Validation fraction for preprocessing split
    "val_fraction": 0.1,
    // Test fraction for preprocessing split
    "test_fraction": 0.1,
    // Minimum j−i offset for targets
    "min_steps": 1,
    // Maximum j−i offset for targets (null = T-1)
    "max_steps": 99,
    // Anchors per trajectory per epoch
    "pairs_per_traj": 4,

    "adaptive_stiff_loss": {
      "lambda_phys": 1.0,
      "lambda_z": 0.5,
      "use_weighting": true, // Set to false for equal 1.0 weights
      "weight_power": 0.5,   // Change to 1.0 for linear weighting
      "w_min": 0.5,          // The lowest weight a species can have
      "w_max": 2.0,          // The highest weight a species can have
      "epsilon_phys": 1e-20
    }
  }
}
